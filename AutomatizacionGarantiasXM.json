{"files":[{"id":"4f07958d-3a9e-4d03-8ec7-fde406501fd3","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/Bogota\",\n  \"dependencies\": {\n    \"enabledAdvancedServices\": [\n      {\n        \"userSymbol\": \"Drive\",\n        \"version\": \"v2\",\n        \"serviceId\": \"drive\"\n      }\n    ]\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"50971e05-8252-49ea-9f44-52afdeb8ee2d","name":"C√≥digo","type":"server_js","source":"function automatizacionGarantiasXM() {\n  const nombreCarpetaPrincipal \u003d \"Garant√≠as\";\n  const nombreArchivoMaestro \u003d \"AutomatizacionGarantias\";\n  const fechaHoy \u003d new Date();\n  fechaHoy.setHours(0,0,0,0);\n  \n  try {\n    const carpetaRaiz \u003d DriveApp.getFoldersByName(nombreCarpetaPrincipal).next();\n    const maestros \u003d DriveApp.getFilesByName(nombreArchivoMaestro);\n    if (!maestros.hasNext()) throw \"No se encontr√≥ el archivo maestro.\";\n    const datosMaestros \u003d SpreadsheetApp.open(maestros.next()).getSheets()[0].getDataRange().getValues();\n\n    const carpetas \u003d {};\n    const subcarpetas \u003d carpetaRaiz.getFolders();\n    while (subcarpetas.hasNext()) {\n      let sub \u003d subcarpetas.next();\n      carpetas[sub.getName().toUpperCase()] \u003d sub;\n    }\n\n    // --- OBTENER EL SALDO M√ÅS RECIENTE PARA TODOS LOS AGENTES ---\n    const saldosCuentas \u003d obtenerSaldosMasRecientes(carpetas[\"CUENTAS\"]);\n\n    for (let i \u003d 1; i \u003c datosMaestros.length; i++) {\n      let codBuscado \u003d datosMaestros[i][0] ? datosMaestros[i][0].toString().trim().toUpperCase() : \"\";\n      let correo \u003d datosMaestros[i][1];\n      let nombreAgente \u003d datosMaestros[i][2];\n      let esquemaAgente \u003d datosMaestros[i][3] ? datosMaestros[i][3].toString().trim().toUpperCase() : \"\";\n      let cuentaAgente \u003d datosMaestros[i][4] ? datosMaestros[i][4].toString().trim() : \"\"; // Columna E\n\n      if (!codBuscado) continue;\n\n      let resumenDeudas \u003d [];\n\n      // 1. CARPETA DE ESQUEMA\n      if (carpetas[esquemaAgente]) {\n        resumenDeudas \u003d resumenDeudas.concat(procesarCarpeta(carpetas[esquemaAgente], codBuscado, fechaHoy, false));\n      }\n\n      // 2. CARPETA TIE\n      if (carpetas[\"TIE\"]) {\n        resumenDeudas \u003d resumenDeudas.concat(procesarCarpeta(carpetas[\"TIE\"], codBuscado, fechaHoy, true));\n      }\n\n      // 3. VALIDACI√ìN DE SALDO\n      let infoSaldo \u003d saldosCuentas[cuentaAgente] || { saldo: 0, fecha: \"No encontrada\" };\n      \n      enviarNotificacionCompleta(nombreAgente, codBuscado, correo, esquemaAgente, resumenDeudas, infoSaldo, cuentaAgente);\n    }\n  } catch (e) {\n    Logger.log(\"‚ùå Error: \" + e.toString());\n  }\n}\n\n// NUEVA FUNCI√ìN: Busca el archivo m√°s reciente en \"Cuentas\" y mapea Cuenta -\u003e Saldo\nfunction obtenerSaldosMasRecientes(carpetaCuentas) {\n  if (!carpetaCuentas) return {};\n  let archivos \u003d carpetaCuentas.getFiles();\n  let archivoMasReciente \u003d null;\n  let ultimaFecha \u003d new Date(0);\n\n  while (archivos.hasNext()) {\n    let arc \u003d archivos.next();\n    let f \u003d extraerFechaDelNombre(arc.getName());\n    if (f \u0026\u0026 f \u003e ultimaFecha) {\n      ultimaFecha \u003d f;\n      archivoMasReciente \u003d arc;\n    }\n  }\n\n  if (!archivoMasReciente) return {};\n\n  let matriz \u003d obtenerMatrizConvertida(archivoMasReciente);\n  let mapaSaldos \u003d {};\n  for (let f \u003d 0; f \u003c matriz.length; f++) {\n    let cuenta \u003d matriz[f][1] ? matriz[f][1].toString().trim() : \"\"; // Columna B\n    let saldo \u003d parseFloat(matriz[f][9]) || 0; // Columna J\n    if (cuenta) {\n      mapaSaldos[cuenta] \u003d { saldo: saldo, fecha: ultimaFecha.toLocaleDateString() };\n    }\n  }\n  return mapaSaldos;\n}\n\nfunction procesarCarpeta(carpeta, codBuscado, fechaHoy, esTIE) {\n  let hallazgos \u003d [];\n  let archivos \u003d carpeta.getFiles();\n  while (archivos.hasNext()) {\n    let archivo \u003d archivos.next();\n    let fechaDoc \u003d extraerFechaDelNombre(archivo.getName());\n    if (fechaDoc \u0026\u0026 fechaDoc \u003e\u003d fechaHoy) {\n      let matriz \u003d obtenerMatrizConvertida(archivo);\n      if (!matriz) continue;\n      for (let f \u003d 0; f \u003c matriz.length; f++) {\n        if (matriz[f][0] \u0026\u0026 matriz[f][0].toString().trim().toUpperCase() \u003d\u003d\u003d codBuscado) {\n          let valor \u003d 0;\n          if (esTIE) {\n            valor \u003d parseFloat(matriz[f][3]) || 0;\n          } else {\n            for (let c \u003d 3; c \u003c matriz[f].length; c++) {\n              let n \u003d parseFloat(matriz[f][c].toString().replace(/[^\\d.-]/g, \u0027\u0027));\n              if (!isNaN(n)) valor +\u003d n;\n            }\n          }\n          if (Math.abs(valor) \u003e 0.01) {\n            hallazgos.push({ archivo: archivo.getName(), valor: valor, vencimiento: fechaDoc.toLocaleDateString(\u0027es-CO\u0027) });\n          }\n          break;\n        }\n      }\n    }\n  }\n  return hallazgos;\n}\n\nfunction enviarNotificacionCompleta(nombre, cod, correo, esquema, deudas, infoSaldo, cuenta) {\n  if (!correo) return;\n  \n  let totalDeuda \u003d deudas.reduce((acc, d) \u003d\u003e acc + d.valor, 0);\n  let diferencia \u003d infoSaldo.saldo - totalDeuda;\n  let asunto \u003d `Resumen de Garant√≠as y Cuenta Custodia - ${cod}`;\n  \n  // --- INICIO DEL CUERPO DEL CORREO ---\n  let cuerpo \u003d `Estimado ${nombre},\\n\\n`;\n  cuerpo +\u003d `Se han procesado los reportes de garant√≠as vigentes para el esquema ${esquema} e Internacionales (TIE). Detalle:\\n\\n`;\n\n  // SECCI√ìN 1: DETALLE DE ARCHIVOS\n  if (deudas.length \u003e 0) {\n    deudas.forEach(d \u003d\u003e {\n      let etiqueta \u003d d.valor \u003c 0 ? \"SALDO A FAVOR\" : \"VALOR A PAGAR\";\n      let signo \u003d d.valor \u003c 0 ? \" (-)\" : \"\";\n      cuerpo +\u003d `‚Ä¢ ARCHIVO: ${d.archivo}\\n`;\n      cuerpo +\u003d `  ${etiqueta}: $${Math.abs(d.valor).toLocaleString(\u0027es-CO\u0027, { minimumFractionDigits: 2 })}${signo}\\n`;\n      cuerpo +\u003d `  VENCE: ${d.vencimiento}\\n\\n`;\n    });\n\n    cuerpo +\u003d `-------------------------------------------\\n`;\n    cuerpo +\u003d `TOTAL NETO CONSOLIDADO: $${totalDeuda.toLocaleString(\u0027es-CO\u0027, { minimumFractionDigits: 2 })}\\n`;\n    cuerpo +\u003d `-------------------------------------------\\n\\n`;\n  } else {\n    cuerpo +\u003d `‚Ä¢ No se identificaron garant√≠as pendientes por cubrir.\\n\\n`;\n  }\n\n  // SECCI√ìN 2: ESTADO DE CUENTA CUSTODIA (Visualmente diferenciado)\n  cuerpo +\u003d `ESTADO DE CUENTA CUSTODIA\\n`;\n  cuerpo +\u003d `Cuenta No: ${cuenta}\\n`;\n  cuerpo +\u003d `Saldo Disponible: $${infoSaldo.saldo.toLocaleString(\u0027es-CO\u0027, { minimumFractionDigits: 2 })}\\n`;\n  cuerpo +\u003d `Fecha de Corte: ${infoSaldo.fecha}\\n\\n`;\n\n  // SECCI√ìN 3: AN√ÅLISIS DE COBERTURA Y ACCI√ìN\n  cuerpo +\u003d `AN√ÅLISIS DE COBERTURA:\\n`;\n  \n  if (diferencia \u003e\u003d 0) {\n    cuerpo +\u003d `‚úÖ SALDO SUFICIENTE: El saldo disponible cubre las obligaciones actuales. \\n`;\n    cuerpo +\u003d `   Sobrante estimado: $${diferencia.toLocaleString(\u0027es-CO\u0027, { minimumFractionDigits: 2 })}\\n\\n`;\n  } else {\n    cuerpo +\u003d `‚ö†Ô∏è SALDO INSUFICIENTE: Se requiere un fondeo adicional en la cuenta.\\n`;\n    cuerpo +\u003d `   Monto m√≠nimo a transferir: $${Math.abs(diferencia).toLocaleString(\u0027es-CO\u0027, { minimumFractionDigits: 2 })}\\n\\n`;\n  }\n\n  if (totalDeuda \u003c 0) {\n    cuerpo +\u003d `Nota: El saldo total neto de garant√≠as es a su favor.\\n\\n`;\n  }\n\n  cuerpo +\u003d `Cordialmente,\\n\\nENERCONSULT`;\n  // --- FIN DEL CUERPO DEL CORREO ---\n\n  GmailApp.sendEmail(correo, asunto, cuerpo);\n  Logger.log(`üì§ Notificaci√≥n enviada a ${cod}`);\n}\n\nfunction extraerFechaDelNombre(nombre) {\n  const meses \u003d {\"JAN\":0,\"FEB\":1,\"MAR\":2,\"APR\":3,\"MAY\":4,\"JUN\":5,\"JUL\":6,\"AUG\":7,\"SEP\":8,\"OCT\":9,\"NOV\":10,\"DEC\":11,\"ENE\":0,\"ABR\":3,\"AGO\":7,\"DIC\":11};\n  let m1 \u003d nombre.match(/(\\d{1,2})(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC|ENE|ABR|AGO|DIC)[- ]?(\\d{4})/i);\n  if (m1) return new Date(m1[3], meses[m1[2].toUpperCase()], m1[1]);\n  let m2 \u003d nombre.match(/(\\d{4})[-/](\\d{1,2})[-/](\\d{1,2})/) || nombre.match(/(\\d{1,2})[-/](\\d{1,2})[-/](\\d{4})/);\n  if (m2) {\n    if (m2[1].length \u003d\u003d\u003d 4) return new Date(m2[1], parseInt(m2[2])-1, m2[3]);\n    return new Date(m2[3], parseInt(m2[2])-1, m2[1]);\n  }\n  return null;\n}\n\nfunction obtenerMatrizConvertida(archivo) {\n  try {\n    const tempFile \u003d Drive.Files.insert({title: \"TEMP\", mimeType: MimeType.GOOGLE_SHEETS}, archivo.getBlob(), {convert: true});\n    const data \u003d SpreadsheetApp.openById(tempFile.id).getSheets()[0].getDataRange().getValues();\n    Drive.Files.remove(tempFile.id);\n    return data;\n  } catch(e) { return null; }\n}"}]}